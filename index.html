<!DOCTYPE html>
<html>
<head>
<title>EgoMonitor</title>
</head>
<body>
<h2>Total: <span id="total"></span></h2>
<ul id="monitors"></ul>
</body>
<script src="jquery-1.6.2.js"></script>
<script src="mustache.js"></script>
<script src="underscore.js"></script>
<script>
var EgoMonitor = (function () {
  'use strict';

  /** @module */
  var ns = {};

  /** Thin wrapper around localStorage with convenience functions. */
  ns.Storage = function () { 
    this.storage = localStorage;
  };

  ns.Storage.prototype = {
    constructor: ns.Storage,
    get: function (key) {
      return this.storage.getItem(key);
    },
    set: function (key, value) {
      return this.storage.setItem(key, JSON.stringify(value));
    },
    clear: function () {
      return this.storage.clear();
    }
  };

  // Only one instance since it's pointing to localStorage.
  ns.cache = new ns.Storage();

  ns.EgoMonitor = function (config) {
    this.instantiate(config);
  };

  ns.EgoMonitor.prototype = {
    constructor: ns.EgoMonitor,
    instantiate: function (config) {
      var that = this;

      that.instances = config.map(function (c) {
        return new ns[c.connector](c.options);
      });
    },

    templates: {
      score: '<li style="list-style-image: url({{iconURL}})">{{label}} {{score}}</li>'
    },
    refresh: function () {
      var that = this,
          total = 0;

      that.instances.forEach(function (i) {
        i.load(function (data) {
          total += data.score;
          $('#monitors').append(Mustache.to_html(that.templates.score, data));
          $('#total').html(total);
        });
      });
    }
  };

  ns.EgoSource = function () {};
  ns.EgoSource.prototype = {
    constructor: ns.EgoSource,
    key: function () {
      return JSON.stringify(this);
    },
    load: function (callback) {
      var that = this,
          cached = ns.cache.get(that.key()),
          wrappedCallback = function (rawData) {
            ns.cache.set(that.key(), rawData);
            callback(that.transform(rawData));
          };

      if (cached) {
        wrappedCallback(JSON.parse(cached));
      } else {
        jQuery.getJSON(that.jsonpURL(), wrappedCallback);
      }
    }
  };

  /** 
   * @param options {Object} contains {Number} userID of user to monitor and {String} domain of the StackExchange site
   * @example new StackExchange({domain: 'stackoverflow.com', userID: 146764});
   * @constructor
   */
  ns.StackExchange = function (options) {
    this.domain = options.domain;
    this.userID = options.userID;
  };

  ns.StackExchange.prototype = _.extend(new ns.EgoSource(), {
    constructor: ns.StackExchange,
    /** @const */
    API_URL: 'http://api.%domain/1.1/users/%userID',
    ICON_URL: 'http://%domain/favicon.ico',
    iconURL: function () {
      return this.ICON_URL.replace('%domain', this.domain);
    },
    userURL: function () {
      return this.API_URL.replace('%domain', this.domain).replace('%userID', this.userID);
    },
    jsonpURL: function () {
      return [this.userURL(), 'jsonp=?'].join('?');
    },
    transform: function (rawData) {
      return {
        iconURL: this.iconURL(),
        label: this.domain,
        score: rawData.users[0].reputation,
      };
    },
  });

  ns.Twitter = function (options) {
    this.screenName = options.screenName;
  };

  ns.Twitter.prototype = _.extend(new ns.EgoSource(), {
    constructor: ns.Twitter,
    API_URL: 'http://api.twitter.com/1/followers/ids.json',
    ICON_URL: 'http://twitter.com/favicon.ico',
    jsonpURL: function () {
      return [this.API_URL, '?callback=?&', jQuery.param({screen_name: this.screenName})].join('');
    },
    transform: function (rawData) {
      return {
        iconURL: this.ICON_URL,
        label: this.screenName,
        score: rawData.length,
      };
    },
  });

  // ns.RubyGems = function (options) {
  //   this.gemName = options.gemName;
  // };

  // ns.RubyGems.prototype = _.extend(new ns.EgoSource(), {
  //   constructor: ns.RubyGems,
  //   API_URL: 'http://rubygems.org/api/v1/versions/%gemName.json',
  //   ICON_URL: 'http://rubygems.org/favicon.ico',
  //   jsonpURL: function () {
  //     // TODO
  //   }
  // });

  ns.GitHub = function (options) {
    this.userName = options.userName;
    this.repoName = options.repoName;
  };

  ns.GitHub.prototype = _.extend(new ns.EgoSource(), {
    constructor: ns.GitHub,
    API_URL: 'http://github.com/api/v2/json/repos/show/%userName/%repoName',
    ICON_URL: 'http://github.com/favicon.ico',
    jsonpURL: function () {
      return [this.API_URL.replace('%userName', this.userName).replace('%repoName', this.repoName), 'callback=?'].join('?');
    },
    transform: function (rawData) {
      var repo = rawData.repository;
      return {
        iconURL: this.ICON_URL,
        label: [this.userName, this.repoName].join('/'),
        score: repo.watchers + repo.forks,
      };
    }
  });

  return ns;
}());

// TODO get rid of global
var config = [
  {connector: 'GitHub', options: {userName: 'benjaminoakes', repoName: 'maid'}},
  {connector: 'GitHub', options: {userName: 'benjaminoakes', repoName: 'tabcarousel'}},
  {connector: 'StackExchange', options: {domain: 'stackoverflow.com', userID: 146764}},
  {connector: 'StackExchange', options: {domain: 'superuser.com', userID: 13827}},
  {connector: 'StackExchange', options: {domain: 'unix.stackexchange.com', userID: 569}},
  {connector: 'StackExchange', options: {domain: 'askubuntu.com', userID: 1528}},
  {connector: 'Twitter', options: {screenName: 'altimagination'}},
  {connector: 'Twitter', options: {screenName: 'benjaminoakes'}},
  {connector: 'Twitter', options: {screenName: 'newhavenrb'}},
  // {connector: 'RubyGems', options {gemName: 'maid'}},
  // {connector: 'RubyGems', options {gemName: 'snow'}},
  // {connector: 'RubyGems', options {gemName: 'mailroom'}},
];

$(document).ready(function () {
  var em = new EgoMonitor.EgoMonitor(config);
  em.refresh();
});
</script>
</html>
